(window.webpackJsonp=window.webpackJsonp||[]).push([[64],{361:function(t,s,a){"use strict";a.r(s);var n=a(7),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"userdetails"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#userdetails"}},[t._v("#")]),t._v(" UserDetails")]),t._v(" "),s("p",[t._v("用户登录时，系统会根据用户名，从存储设备查找该用户的密码及权限等，将其组装成一个UserDetails对象。并用UserDetails中的数据对用户进行认证，决定其输入的用户名/密码是否正确。")]),t._v(" "),s("p",[t._v("此对象我们一般都不直接调用，而是使用"),s("code",[t._v("UserDetailsService")]),t._v("接口返回，我们可以实现此接口，然后返回一个"),s("code",[t._v("UserDetails")])]),t._v(" "),s("blockquote",[s("p",[s("a",{attrs:{href:"https://docs.spring.io/spring-security/reference/servlet/authentication/passwords/dao-authentication-provider.html#servlet-authentication-daoauthenticationprovider",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("DaoAuthenticationProvider")]),s("OutboundLink")],1),t._v("验证"),s("code",[t._v("UserDetails")]),t._v("，然后返回一个已配置"),s("a",{attrs:{href:"https://docs.spring.io/spring-security/reference/servlet/authentication/architecture.html#servlet-authentication-authentication",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("Authentication")]),s("OutboundLink")],1),t._v("的主体的主体。"),s("code",[t._v("UserDetails UserDetailsService")])])]),t._v(" "),s("p",[t._v("此接口中的方法，任何一个返回"),s("code",[t._v("false")]),t._v("都会导致认证失败")]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("interface")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("UserDetails")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Serializable")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Collection")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("GrantedAuthority")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getAuthorities")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//权限 ")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getPassword")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//密码")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getUsername")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//用户名")]),t._v("\n \n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("isAccountNonExpired")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("   "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//账号是否未过期")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("isAccountNonLocked")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//账号是否未锁定")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("isCredentialsNonExpired")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//密码是否未过期")]),t._v("\n\t"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("isEnabled")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//是否激活")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br")])]),s("p",[t._v("例如")]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Service")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"userDetailsService"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("LoginService")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("implements")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("UserDetailsService")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Autowired")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("UserMapper")]),t._v(" userMapper"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Override")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("UserDetails")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("loadUserByUsername")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" username"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("UsernameNotFoundException")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("QueryWrapper")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Users")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" wrapper "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("QueryWrapper")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    wrapper"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("eq")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"username"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("username"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Users")]),t._v(" user "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" userMapper"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("selectOne")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("wrapper"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("user "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//数据库中，没有该条记录，认证失败")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throw")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("UsernameNotFoundException")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"用户不存在"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("List")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("GrantedAuthority")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" grantedAuthorities "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AuthorityUtils")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("commaSeparatedStringToAuthorityList")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("user"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getRole")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("User")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("user"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getUsername")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("BCryptPasswordEncoder")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("encode")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("user"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getPassword")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("grantedAuthorities"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br"),s("span",{staticClass:"line-number"},[t._v("24")]),s("br")])]),s("h2",{attrs:{id:"userdetailsservice"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#userdetailsservice"}},[t._v("#")]),t._v(" UserDetailsService")]),t._v(" "),s("p",[t._v("Spring Security中进行身份验证的是AuthenticationManager接口，ProviderManager是它的一个默认实现，但它并不用来处理身份认证，而是委托给配置好的AuthenticationProvider，每个AuthenticationProvider会轮流检查身份认证。检查后或者返回Authentication对象或者抛出异常。")]),t._v(" "),s("p",[t._v("验证身份就是加载响应的UserDetails，看看是否和用户输入的账号、密码、权限等信息匹配。此步骤由实现AuthenticationProvider的DaoAuthenticationProvider（它利用UserDetailsService验证用户名、密码和授权）处理。包含 GrantedAuthority 的 UserDetails对象在构建 Authentication对象时填入数据。")]),t._v(" "),s("p",[t._v("Spring Security 提供"),s("a",{attrs:{href:"https://docs.spring.io/spring-security/reference/servlet/authentication/passwords/in-memory.html#servlet-authentication-inmemory",target:"_blank",rel:"noopener noreferrer"}},[t._v("内存"),s("OutboundLink")],1),t._v("和"),s("a",{attrs:{href:"https://docs.spring.io/spring-security/reference/servlet/authentication/passwords/jdbc.html#servlet-authentication-jdbc",target:"_blank",rel:"noopener noreferrer"}},[t._v("JDBC"),s("OutboundLink")],1),t._v("实现"),s("code",[t._v("UserDetailsService")]),t._v("。")]),t._v(" "),s("blockquote",[s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("UserDetails")]),t._v(" loadedUser "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getUserDetailsService")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("loadUserByUsername")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("username"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])])]),t._v(" "),s("h2",{attrs:{id:"daoauthenticationprovider"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#daoauthenticationprovider"}},[t._v("#")]),t._v(" DaoAuthenticationProvider")]),t._v(" "),s("p",[s("code",[t._v("DaoAuthenticationProvider")]),t._v("是"),s("code",[t._v("AuthenticationProvider")]),t._v("接口的一个实现类，"),s("code",[t._v("DaoAuthenticationProvider")]),t._v("根据"),s("code",[t._v("UserDetailsService")]),t._v("和"),s("code",[t._v("PasswordEncoder")]),t._v("来验证用户名和密码")]),t._v(" "),s("p",[t._v("他执行的流程图如下")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://picture.xcye.xyz/image-20220311105937998.png",alt:""}})]),t._v(" "),s("p",[t._v("步骤如下")]),t._v(" "),s("ol",[s("li",[s("p",[t._v("认证过滤器读取到用户名和密码，然后将用户名和密码传递给"),s("code",[t._v("UsernamePasswordAuthenticationToken")])]),t._v(" "),s("p",[t._v("``ProviderManager"),s("code",[t._v("是")]),t._v("AuthenticationManager`的一个实现类")])]),t._v(" "),s("li",[s("p",[t._v("然后"),s("code",[t._v("ProviderManager")]),t._v("是被配置用来使用"),s("code",[t._v("AuthenticationProvider")]),t._v("，因为我们要使用"),s("code",[t._v("DaoAuthenticationProvider")]),t._v("，"),s("code",[t._v("DaoAuthenticationProvider")]),t._v("是"),s("code",[t._v("AuthenticationProvider")]),t._v("的一个实现类")]),t._v(" "),s("blockquote",[s("p",[t._v("所以如果有一个"),s("code",[t._v("AuthenticationProvider")]),t._v("对象，那么也就有了"),s("code",[t._v("DaoAuthenticationProvider")]),t._v("对象")])])]),t._v(" "),s("li",[s("p",[s("code",[t._v("DaoAuthenticationProvider")]),t._v(" 会从 "),s("code",[t._v("UserDetailsService")]),t._v("中寻找"),s("code",[t._v("UserDetails")])]),t._v(" "),s("blockquote",[s("p",[s("code",[t._v("UserDetails")]),t._v("存储了用户的信息")])])]),t._v(" "),s("li",[s("p",[s("code",[t._v("DaoAuthenticationProvider")]),t._v(" 然后会使用 "),s("a",{attrs:{href:"https://docs.spring.io/spring-security/reference/servlet/authentication/passwords/password-encoder.html#servlet-authentication-password-storage",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("PasswordEncoder")]),s("OutboundLink")],1),t._v(" 来验证用户名和密码，用户名和密码信息是从第三步中返回回来的"),s("code",[t._v("UserDetails")]),t._v("对象中获取到的")])]),t._v(" "),s("li",[s("p",[t._v("当身份信息验证成功后，"),s("a",{attrs:{href:"https://docs.spring.io/spring-security/reference/servlet/authentication/architecture.html#servlet-authentication-authentication",target:"_blank",rel:"noopener noreferrer"}},[s("code",[t._v("Authentication")]),s("OutboundLink")],1),t._v("会返回"),s("code",[t._v("UsernamePasswordAuthenticationToken")]),t._v("，并且将存在"),s("code",[t._v("UserDetails")]),t._v("的"),s("code",[t._v("UserDetailsService")]),t._v("对象返回。")])])]),t._v(" "),s("h2",{attrs:{id:"执行的流程-默认配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#执行的流程-默认配置"}},[t._v("#")]),t._v(" 执行的流程，默认配置")]),t._v(" "),s("h3",{attrs:{id:"usernamepasswordauthenticationfilter过滤器"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#usernamepasswordauthenticationfilter过滤器"}},[t._v("#")]),t._v(" UsernamePasswordAuthenticationFilter过滤器")]),t._v(" "),s("ol",[s("li",[t._v("浏览器发送请求，需要登录，输入错误用户名aurora和错误密码")]),t._v(" "),s("li",[s("code",[t._v("UsernamePasswordAuthenticationFilter")]),t._v("过滤器中的"),s("code",[t._v("attemptAuthentication()")]),t._v("方法执行")])]),t._v(" "),s("h4",{attrs:{id:"attemptauthentication"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#attemptauthentication"}},[t._v("#")]),t._v(" attemptAuthentication()")]),t._v(" "),s("ol",[s("li",[s("p",[t._v("判断请求的方法，如果不是"),s("code",[t._v("post")]),t._v("，那么抛出异常")])]),t._v(" "),s("li",[s("p",[t._v("通过从"),s("code",[t._v("request")]),t._v("对象中，获取到用户名和密码")])]),t._v(" "),s("li",[s("p",[t._v("根据获取到的用户名和密码，创建"),s("code",[t._v("UsernamePasswordAuthenticationToken authRequest = new UsernamePasswordAuthenticationToken(username, password)")]),t._v("对象")]),t._v(" "),s("blockquote",[s("p",[t._v("在构建这个对象的过程中，会对"),s("code",[t._v("authenticated")]),t._v("赋值为false，也就是此用户还没有认证")])])]),t._v(" "),s("li",[s("p",[t._v("此方法执行完，会根据"),s("code",[t._v("UsernamePasswordAuthenticationToken")]),t._v("对象实例化一个"),s("code",[t._v("Authentication")]),t._v("对象")])])]),t._v(" "),s("h3",{attrs:{id:"abstractuserdetailsauthenticationprovider"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#abstractuserdetailsauthenticationprovider"}},[t._v("#")]),t._v(" AbstractUserDetailsAuthenticationProvider")]),t._v(" "),s("p",[t._v("然后程序便会进入到"),s("code",[t._v("AbstractUserDetailsAuthenticationProvider")]),t._v("抽象类中的"),s("code",[t._v("authenticate(Authentication authentication)")]),t._v("方法执行，此抽象类是"),s("code",[t._v("DaoAuthenticationProvider")]),t._v("类的父类")]),t._v(" "),s("p",[t._v("当执行到下面这段代码的时候，便会跳到"),s("code",[t._v("DaoAuthenticationProvider")]),t._v("中去执行")]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    user "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("retrieveUser")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("username"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("UsernamePasswordAuthenticationToken")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" authentication"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br")])]),s("blockquote",[s("p",[t._v("因为在"),s("code",[t._v("AbstractUserDetailsAuthenticationProvider")]),t._v("类中，"),s("code",[t._v("retrieveUser()")]),t._v("是一个抽象方法，"),s("code",[t._v("DaoAuthenticationProvider")]),t._v("是此抽象类的子类，所以就会跳到"),s("code",[t._v("DaoAuthenticationProvider")]),t._v("中")])]),t._v(" "),s("h3",{attrs:{id:"daoauthenticationprovider-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#daoauthenticationprovider-2"}},[t._v("#")]),t._v(" DaoAuthenticationProvider")]),t._v(" "),s("p",[t._v("执行完上面的方法，程序便跳到"),s("code",[t._v("DaoAuthenticationProvider")]),t._v("类中，执行"),s("code",[t._v("retrieveUser(String username, UsernamePasswordAuthenticationToken authentication)")]),t._v("方法")]),t._v(" "),s("ol",[s("li",[s("p",[t._v("执行"),s("code",[t._v("UserDetailsService")]),t._v("类中的"),s("code",[t._v("loadUserByUsername(username)")]),t._v("方法，此方法返回的是一个"),s("code",[t._v("UserDetails")]),t._v("对象")]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("UserDetails")]),t._v(" loadedUser "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getUserDetailsService")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("loadUserByUsername")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("username"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("blockquote",[s("p",[t._v("此"),s("code",[t._v("loadedUser")]),t._v("对象中，存放的是正确的用户名和密码")])]),t._v(" "),s("p",[t._v("因为这里输入的是一个错误用户名和错误密码，所以执行抛出一个"),s("code",[t._v("UsernameNotFoundException")]),t._v("异常")]),t._v(" "),s("p",[t._v("如果此用户存在的话，那么就会通过"),s("code",[t._v("User")]),t._v("类，根据用户名，密码等实例化"),s("code",[t._v("UserDetails")]),t._v("对象")]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("User")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("user"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getUsername")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" user"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getPassword")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" user"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("isEnabled")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" user"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("isAccountNonExpired")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                user"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("isCredentialsNonExpired")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" user"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("isAccountNonLocked")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" user"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getAuthorities")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br")])]),s("p",[t._v("如果用户不存在，那么就"),s("a",{attrs:{href:"#%E7%94%A8%E6%88%B7%E4%B8%8D%E5%AD%98%E5%9C%A8"}},[t._v("跳到")])])]),t._v(" "),s("li",[s("p",[t._v("如果用户名是正确的，那么程序会继续"),s("a",{attrs:{href:"#%E7%BB%A7%E7%BB%AD"}},[t._v("执行")])])])]),t._v(" "),s("h4",{attrs:{id:"用户不存在"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#用户不存在"}},[t._v("#")]),t._v(" 用户不存在")]),t._v(" "),s("ol",[s("li",[t._v("会跳到"),s("code",[t._v("AbstractAuthenticationProcessingFilter")]),t._v("类中的"),s("code",[t._v("doFilter(HttpServletRequest request, HttpServletResponse response, FilterChain chain)")]),t._v("方法，在此方法中，会抛出一个异常，然后执行"),s("code",[t._v("unsuccessfulAuthentication(request, response, ex);")]),t._v("方法")]),t._v(" "),s("li",[t._v("然后跳到"),s("code",[t._v("LogoutFilter")]),t._v("类中的"),s("code",[t._v("doFilter(xxx)")])]),t._v(" "),s("li",[t._v("然后后续还有一个过滤器需要执行")])]),t._v(" "),s("h3",{attrs:{id:"继续"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#继续"}},[t._v("#")]),t._v(" 继续")]),t._v(" "),s("p",[t._v("这一步还是在"),s("code",[t._v("AbstractUserDetailsAuthenticationProvider")]),t._v("类中的"),s("code",[t._v("authenticate(Authentication authentication)")]),t._v("方法中执行")]),t._v(" "),s("p",[t._v("通过"),s("code",[t._v("AbstractUserDetailsAuthenticationProvider")]),t._v("的子类"),s("code",[t._v("DefaultPreAuthenticationChecks")]),t._v("执行"),s("code",[t._v("retrieveUser()")]),t._v("方法获取大到正确的用户名和密码对象后")]),t._v(" "),s("p",[t._v("然后会跳到"),s("code",[t._v("DefaultPreAuthenticationChecks")]),t._v("类中的"),s("code",[t._v("check(UserDetails user)")]),t._v("方法，检查用户是否被锁着，被锁住的的用户无法被验证")]),t._v(" "),s("blockquote",[s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//对应执行下面代码")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("preAuthenticationChecks"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("check")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("user"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("additionalAuthenticationChecks")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("user"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("UsernamePasswordAuthenticationToken")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" authentication"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br")])])]),t._v(" "),s("p",[t._v("在这个方法中，会依次调用"),s("code",[t._v("UserDetails")]),t._v("中的")]),t._v(" "),s("blockquote",[s("p",[t._v("isAccountNonLocked(),isEnabled(),isAccountNonExpired()")])]),t._v(" "),s("p",[t._v("三个方法，如果里面的值为false，那么都将抛出对应的异常")]),t._v(" "),s("p",[t._v("当执行完"),s("code",[t._v("this.preAuthenticationChecks.check(user);")]),t._v("之后，便会执行"),s("code",[t._v("additionalAuthenticationChecks(user, (UsernamePasswordAuthenticationToken) authentication);")]),t._v("，验证用户传入的密码是否正确")]),t._v(" "),s("p",[t._v("其中user是存放正确的用户名和密码的"),s("code",[t._v("UserDetails")]),t._v("对象，而"),s("code",[t._v("(UsernamePasswordAuthenticationToken) authentication)")]),t._v("是用户当前输入的"),s("code",[t._v("UserDetails")]),t._v("对象")]),t._v(" "),s("p",[t._v("对密码进行检查，调用的是"),s("code",[t._v("PasswordEncoder")]),t._v("对象中的"),s("code",[t._v("matches()")]),t._v("方法，如果密码不正确，那么就会抛出异常，然后后面的过程，也基本上和用户名错误差不多")]),t._v(" "),s("p",[t._v("如果此步密码正确，那么请"),s("a",{attrs:{href:"#%E7%94%A8%E6%88%B7%E5%90%8D%E5%92%8C%E5%AF%86%E7%A0%81%E9%83%BD%E6%AD%A3%E7%A1%AE"}},[t._v("跳到")])]),t._v(" "),s("h3",{attrs:{id:"用户名和密码都正确"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#用户名和密码都正确"}},[t._v("#")]),t._v(" 用户名和密码都正确")]),t._v(" "),s("ol",[s("li",[s("p",[t._v("执行"),s("code",[t._v("this.postAuthenticationChecks.check(user);")]),t._v("判断用户的密码凭证是否过期，最终也就是调用"),s("code",[t._v("UserDetails")]),t._v("对象中的"),s("code",[t._v("isCredentialsNonExpired()")]),t._v("方法，进行判断")]),t._v(" "),s("p",[t._v("如果已经过期，就会抛出异常")])]),t._v(" "),s("li",[s("p",[t._v("然后就会通过执行"),s("code",[t._v("createSuccessAuthentication(principalToReturn, authentication, user);")]),t._v("返回一个已经验证成功的"),s("code",[t._v("Authentication")]),t._v("对象，此"),s("code",[t._v("Authentication")]),t._v("对象最终是使用"),s("code",[t._v("UsernamePasswordAuthenticationToken")]),t._v("类创建的")])])]),t._v(" "),s("p",[t._v("中间还有其他的一些过程，就省略了，最后会在"),s("code",[t._v("AbstractAuthenticationProcessingFilter")]),t._v("类中的"),s("code",[t._v("doFilter(HttpServletRequest request, HttpServletResponse response, FilterChain chain)")]),t._v("方法中，调用"),s("code",[t._v("successfulAuthentication(request, response, chain, authenticationResult);")]),t._v("方法")]),t._v(" "),s("h2",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),s("h3",{attrs:{id:"userdetailsservice-userdetails"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#userdetailsservice-userdetails"}},[t._v("#")]),t._v(" UserDetailsService UserDetails")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://picture.xcye.xyz/image-20220311191851697.png",alt:""}})]),t._v(" "),s("p",[t._v("通过上面的源码分析之后，我们发现，通过"),s("code",[t._v("UserDetailsService")]),t._v("对象获取"),s("code",[t._v("UserDetails")]),t._v("对象，是发生在"),s("code",[t._v("DaoAuthenticationProvider")]),t._v("类中的处"),s("code",[t._v("UserDetails loadedUser = this.getUserDetailsService().loadUserByUsername(username);")]),t._v("这段代码中的")]),t._v(" "),s("p",[t._v("如果当前应用中，我们自己创建一个类实现"),s("code",[t._v("UserDetailsService")]),t._v("接口，并将其使用"),s("code",[t._v("@Component")]),t._v("注解添加到容器中的话，那么此处的"),s("code",[t._v("this.getUserDetailsService()")]),t._v("对象就是我们自己实现的这个"),s("code",[t._v("UserDetailsService")]),t._v("对象")]),t._v(" "),s("p",[t._v("而且我们也可以自己写一个类，实现"),s("code",[t._v("UserDetails")]),t._v("接口，然后在我们自己的"),s("code",[t._v("UserDetailsService")]),t._v("实现类中，将此"),s("code",[t._v("UserDetails")]),t._v("实现类"),s("code",[t._v("return")]),t._v("就行了")]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("interface")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("UserDetails")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Serializable")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Collection")]),s("span",{pre:!0,attrs:{class:"token generics"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("GrantedAuthority")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getAuthorities")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//权限 ")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getPassword")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//密码")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getUsername")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//用户名")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("isAccountNonExpired")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("   "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//账号是否未过期")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("isAccountNonLocked")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//账号是否未锁定")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("isCredentialsNonExpired")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//密码是否未过期")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("isEnabled")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//是否激活")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br")])]),s("p",[s("code",[t._v("UserDetails")]),t._v("中的方法逻辑，我们想怎么写，就怎么写")]),t._v(" "),s("blockquote",[s("p",[t._v("而且值得注意的是，"),s("code",[t._v("DaoAuthenticationProvider")]),t._v("类中的一些方法，比如setUserDetailsService()，setPasswordEncoder()在程序启动的时候，便会执行")])]),t._v(" "),s("h3",{attrs:{id:"passwordencoder"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#passwordencoder"}},[t._v("#")]),t._v(" PasswordEncoder")]),t._v(" "),s("p",[t._v("我们也可以自己实现"),s("code",[t._v("PasswordEncoder")])]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Component")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MyPasswordEncoder")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("implements")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("PasswordEncoder")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Override")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("encode")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CharSequence")]),t._v(" rawPassword"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("System")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("out"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("println")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"zhixing"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Override")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("boolean")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("matches")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("CharSequence")]),t._v(" rawPassword"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" encodedPassword"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("System")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("out"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("println")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"qipei"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br")])]),s("p",[t._v("自定义我们自己的密码匹配和密码编码逻辑")]),t._v(" "),s("p",[t._v("但是spring security中，已经写好了一些实现类，我们直接使用"),s("code",[t._v("@Bean")]),t._v("配置一下就行")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://picture.xcye.xyz/image-20220311191701772.png",alt:""}})]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Bean")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("PasswordEncoder")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("password")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("BCryptPasswordEncoder")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br")])]),s("blockquote",[s("p",[t._v("在进行密码比对的时候，一定要保证数据库中，或者是UserDetailsService返回的对象中的密码是通过PasswordEncoder类中的encode()方法返回的字符串，否则验证不会通过")]),t._v(" "),s("p",[s("code",[t._v("matches(CharSequence rawPassword, String encodedPassword)")]),t._v("方法的第一个参数是用户输入的密码字符串，没有经过任何处理，而第二个是经过"),s("code",[t._v("encode()")]),t._v("方法处理后的字符串，不能看到")]),t._v(" "),s("p",[t._v("而且我们也不能将经过"),s("code",[t._v("encode()")]),t._v("处理后的密码，解析成明文")])])])}),[],!1,null,null,null);s.default=e.exports}}]);